<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oti.team2.board.dao.IBoardDao">
	
	<!-- 공지사항/문의게시판 + 첨부파일 글 저장 -->
	<insert id="insertBoard" parameterType="boardRequestDto">
	<selectKey keyProperty="bbsNo" resultType="int" order="AFTER">
			SELECT BBS_NO_SEQ.CURRVAL FROM DUAL
		</selectKey>
		INSERT INTO BOARD(  BBS_NO ,
							BBS_TYPE, 
							BBS_TTL ,
							BBS_CN ,
							WRTR_ID ,
							INQ_CNT ,
							ANS_YN ,
							SR_NO ,
							ATCH_YN )
		<choose>
			<when test="bbsType == 'QNA'">
				VALUES(BBS_NO_SEQ.nextval, #{bbsType}, #{bbsTtl}, #{bbsCn}, #{wrtrId}, #{inqCnt, jdbcType=NULL}, #{ansYn}, #{srNo}, #{atchYn})
			</when>
			<otherwise>
				VALUES(BBS_NO_SEQ.nextval, #{bbsType}, #{bbsTtl}, #{bbsCn}, #{wrtrId}, 0, 0, #{srNo, jdbcType=NULL}, #{atchYn})
			</otherwise>
		</choose> 
	</insert>
	
	<!--  공지사항/문의게시판 페이징 처리 -->
	<select id="countTotalByBbsType" parameterType="map" resultType="int">
		SELECT
			COUNT(BBS_NO)
			
		FROM BOARD b
			<if test="clientId != null">
				, MEMBERS m
			</if>
		where 
			<if test="clientId != null">
				b.WRTR_ID = m.member_id
				and 
				b.WRTR_ID = #{clientId}
				and
			</if>
			BBS_TYPE = upper(#{type})
	</select>
	
	<!--  공지사항/문의게시판 목록 조회 -->
	<select id="selectBoardListByBbsType" parameterType="map" resultType="boardListDto">
		SELECT
			BBS_NO as bbsNo,
			BBS_TTL as bbsTtl,
			ANS_YN as ansYn,
			INQ_CNT as inqCnt,
			WRT_YMD as wrtYmd,
			m.FLNM as wrtNm
		FROM BOARD b, MEMBERS m
		where b.WRTR_ID = m.member_id
			<if test="clientId != null">
				and b.WRTR_ID = #{clientId}
			</if>
			and BBS_TYPE = upper(#{type})
		ORDER BY WRT_YMD DESC
		OFFSET #{pager.startRowNo}-1 ROWS FETCH NEXT #{pager.rowsPerPage} ROWS ONLY
	</select>
	
	<!-- 공지사항/문의게시판  상세 조회  -->
	<select id="selectBoardByBbsNo" parameterType="int" resultType="board">
		SELECT
			BBS_NO as bbsNo,
			BBS_TYPE as bbsType,
			BBS_TTL as bbsTtl,
			BBS_CN as bbsCn,
			WRT_YMD as wrtYmd,
			m.flnm as wrtrNm,
			b.WRTR_ID as wrtrId,
			INQ_CNT as inqCnt,
			ANS_YN as ansYn,
			SR_NO as srNo,
			ATCH_YN as atchYn
		FROM BOARD b, MEMBERS m
		where b.WRTR_ID = m.member_id	
		AND BBS_NO = #{bbsNo}
	</select>
	
	<!-- 공지사항 조회 시 : 조회수 ++ -->
	<update id="updateInqCnt" parameterType="int">
		UPDATE BOARD
		SET INQ_CNT = INQ_CNT + 1
        where BBS_NO = #{bbsNo}
	</update>
	
	<!-- 게시글 수정 -->
	<update id="updateTtlAndCn" parameterType="boardUpdateDto">
		UPDATE BOARD
		SET BBS_TTL = #{bbsTtl},
			BBS_CN = #{bbsCn}
        where BBS_NO = #{bbsNo}
	</update>
	
	<!-- 게시글의 첨부파일 존재 유무 상태 update-->
	<update id="updateAtchYn" parameterType="map">
		UPDATE BOARD
		SET ATCH_YN = #{status}
        where BBS_NO = #{bbsNo}
        	and 
        	ATCH_YN != #{status}
	</update>
	
</mapper>