<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oti.team2.srinformation.dao.ISrinformationDao"> <!-- 식별 이름은 전체 이름을 넣어야됨 -->
	<!-- 모든 진척 목록(조회) -->
	<select id="selectInfoAll" parameterType="string" resultType="srinformationlist">
		SELECT
		    SI.DMND_NO AS dmndNo,
		    SI.SR_NO AS srNo,
		    S1.SYS_NM AS sysNm,
		    T.TASK_SE_NM AS taskSeNm,
		    SD.TTL AS ttl,
		    M.FLNM AS flnm,
		    SI.BGNG_YMD AS bgngYmd,
		    SI.END_YMD AS endYmd,
		    S2.STTS_NM AS sttsNm
		FROM 
		    SR_INFORMATION SI, SR_DEMAND SD, TASK T, MEMBERS M, SYSTEMS S1, STATUS S2 
		    <if test="srInfoFilter.empId != null">
		    , SR_RESOURCES R
		    </if>
		WHERE 
		    SD.DMND_NO = SI.DMND_NO
		AND
		    SD.TASK_SE_CD = T.TASK_SE_CD
		AND
		    SD.CUST_ID = M.MEMBER_ID
		AND
		    S1.SYS_CD = SD.SYS_CD
		AND
		    S2.STTS_CD = SD.STTS_CD
		<if test="srInfoFilter.sysCd != null">
		AND
		    SD.SYS_CD = #{srInfoFilter.sysCd}
		</if>
		<if test="srInfoFilter.taskSeCd != null">
		AND 
		    SD.TASK_SE_CD = #{srInfoFilter.taskSeCd}
		</if>
		<if test="srInfoFilter.sttsCd != null">
		AND
		    SD.STTS_CD = #{srInfoFilter.sttsCd}
		</if>
		<if test="srInfoFilter.ttl != null">
		AND
		    SD.TTL LIKE '%'||#{srInfoFilter.ttl}||'%'
		</if>
		<if test="srInfoFilter.dmndNo != null">
		AND
		    SD.DMND_NO LIKE '%'||#{srInfoFilter.dmndNo}||'%'
		</if>
		<if test="srInfoFilter.empId != null">
		AND
		    R.SR_NO = SI.SR_NO
		AND
		    R.EMP_ID = #{srInfoFilter.empId}
		</if>
		ORDER BY 
		    SI.DMND_NO ASC
		OFFSET #{pager.startRowNo}-1 ROWS FETCH NEXT #{pager.rowsPerPage} ROWS ONLY
	</select>
	
	<!-- 모든 개발부서 목록(조회) -->
	<select id="selectDept" parameterType="string" resultType="dept">
		SELECT
			DEPT_CD AS deptCd,
			DEPT_NM AS deptNm
		FROM
			DEPARTMENTS
	</select>
	
	<!-- 부서 변경시 해당 담당자 출력 -->
	<select id="selectFlnmByDeptCd" parameterType="string" resultType="manager">
		SELECT
			FLNM AS flnm,
			MEMBER_ID AS memberId
		FROM
			DEPARTMENTS D, MEMBERS M
		WHERE
			D.MNGR_ID = M.MEMBER_ID
		AND
			D.DEPT_CD = #{deptCd}
	</select>
	
	<!-- 계획정보 -->
	<select id="selectPlanByDmndNo" parameterType="string" resultType="srplanInformation">
		SELECT
			SD.STTS_CD AS sttsCd,
			SI.DMND_NO AS dmndNo,
			M.MEMBER_ID AS memberId,
			D.DEPT_NM AS deptNm,
			M.FLNM AS flnm,
			to_char(SI.BGNG_YMD, 'YYYY-MM-DD') AS bgngYmd,
			to_char(SI.END_YMD, 'YYYY-MM-DD') AS endYmd,
			SI.RVW_CN AS rvwCn,
			SI.DEPT_CD AS deptCd
		FROM
			SR_INFORMATION SI, MEMBERS M, DEPARTMENTS D, SR_DEMAND SD
		WHERE
			SI.DMND_NO = #{dmndNo}
		AND
			SI.DEPT_CD = D.DEPT_CD
		AND
			SI.PIC_ID = M.MEMBER_ID
		AND
			SI.DMND_NO = SD.DMND_NO
	</select>
	
	<!-- 계획정보 변경 -->
	<update id="updateSrInfo" parameterType="srplanInformation">
		UPDATE 
			SR_INFORMATION
		SET
			BGNG_YMD = #{srplanInfomation.bgngYmd},
			END_YMD = #{srplanInfomation.endYmd},
			DEPT_CD = #{srplanInfomation.deptCd},
			PIC_ID = #{srplanInfomation.memberId},
			RVW_CN = #{srplanInfomation.rvwCn}
		WHERE
			DMND_NO = #{srplanInfomation.dmndNo}
		
	</update>
	<!-- 개발취소시 sr정보 진행여부 false(0)으로 수정 -->
	<update id="updatePrgrsBySrNo" parameterType="string">
		UPDATE
			SR_INFORMATION
		SET
			PRGRS_YN = '0'
		WHERE
			SR_NO = #{srNo}
	</update>	
	<!-- WOR-2023 으로 시작하는 데이터의 수를 가져온다.  -->
	<select id="countBySrNo" parameterType="string" resultType="int">
		SELECT count(SR_NO)
		FROM SR_INFORMATION
		WHERE SR_NO LIKE #{srCode}
	</select>
	
	<!--승인된 요청건을 srInformation 데이터 insert -->
	<insert id="insertSrInformatioin" parameterType="srInformationRequestDto">
		INSERT INTO SR_INFORMATION (
			SR_NO, DMND_NO, DEPT_CD, PIC_ID, RNK, BGNG_YMD, END_YMD)
		VALUES (#{srNo}, #{dmndNo}, #{deptCd}, #{picId}, #{rnk}, #{bgngYmd}, #{endYmd})	
	</insert>
	
	<!-- sr진척목록 전체 행수 조회 -->
	<select id="selectTotalRow" parameterType="map" resultType="int">
		SELECT
			COUNT(SI.SR_NO) as totalRow
		FROM
			SR_INFORMATION SI, SR_DEMAND SD
			<if test="srInfoFilter.taskSeCd != null">
			, TASK T
			</if>
			<if test="srInfoFilter.sysCd != null">
			, SYSTEMS S1
			</if>
			<if test="srInfoFilter.sttsCd != null">
			, STATUS S2 
			</if>
			<if test="srInfoFilter.empId != null">
			, SR_RESOURCES R
			</if>
		WHERE 
		    SD.DMND_NO = SI.DMND_NO
		<if test="srInfoFilter.dmndNo != null">
		AND
		    SD.DMND_NO LIKE '%'||#{srInfoFilter.dmndNo}||'%'
		</if>
		<if test="srInfoFilter.ttl != null">
		AND
		    SD.TTL LIKE '%'||#{srInfoFilter.ttl}||'%'
		</if>
		<if test="srInfoFilter.taskSeCd != null">
		AND
		    SD.TASK_SE_CD = T.TASK_SE_CD
		AND 
		    SD.TASK_SE_CD = #{srInfoFilter.taskSeCd}
		</if>
		<if test="srInfoFilter.sysCd != null">
		AND
		    S1.SYS_CD = SD.SYS_CD
		AND
		    SD.SYS_CD = #{srInfoFilter.sysCd}
		</if>
		<if test="srInfoFilter.sttsCd != null">
		AND
		    S2.STTS_CD = SD.STTS_CD
		AND
		    SD.STTS_CD = #{srInfoFilter.sttsCd}
		</if>
		<if test="srInfoFilter.empId != null">
		AND
		    R.SR_NO = SI.SR_NO
		AND
		    R.EMP_ID = #{srInfoFilter.empId}
		</if>
	</select>
   <!-- 모든 진척 목록(조회) -->
   <select id="selectInfoAll" parameterType="string" resultType="srinformationlist">
      SELECT
          SI.DMND_NO AS dmndNo,
          SI.SR_NO AS srNo,
          S1.SYS_NM AS sysNm,
          T.TASK_SE_NM AS taskSeNm,
          SD.TTL AS ttl,
          M.FLNM AS flnm,
          SI.BGNG_YMD AS bgngYmd,
          SI.END_YMD AS endYmd,
          S2.STTS_NM AS sttsNm
      FROM 
          SR_INFORMATION SI, SR_DEMAND SD, TASK T, MEMBERS M, SYSTEMS S1, STATUS S2 
          <if test="srInfoFilter.empId != null">
          , SR_RESOURCES R
          </if>
      WHERE 
          SD.DMND_NO = SI.DMND_NO
      AND
          SD.TASK_SE_CD = T.TASK_SE_CD
      AND
          SD.CUST_ID = M.MEMBER_ID
      AND
          S1.SYS_CD = SD.SYS_CD
      AND
          S2.STTS_CD = SD.STTS_CD
      <if test="srInfoFilter.sysCd != null">
      AND
          SD.SYS_CD = #{srInfoFilter.sysCd}
      </if>
      <if test="srInfoFilter.taskSeCd != null">
      AND 
          SD.TASK_SE_CD = #{srInfoFilter.taskSeCd}
      </if>
      <if test="srInfoFilter.sttsCd != null">
      AND
          SD.STTS_CD = #{srInfoFilter.sttsCd}
      </if>
      <if test="srInfoFilter.ttl != null">
      AND
          SD.TTL LIKE '%'||#{srInfoFilter.ttl}||'%'
      </if>
      <if test="srInfoFilter.dmndNo != null">
      AND
          SD.DMND_NO LIKE '%'||#{srInfoFilter.dmndNo}||'%'
      </if>
      <if test="srInfoFilter.empId != null">
      AND
          R.SR_NO = SI.SR_NO
      AND
          R.EMP_ID = #{srInfoFilter.empId}
      </if>
      ORDER BY 
          SI.DMND_NO ASC
      OFFSET #{pager.startRowNo}-1 ROWS FETCH NEXT #{pager.rowsPerPage} ROWS ONLY
   </select>
   
   <!-- 모든 개발부서 목록(조회) -->
   <select id="selectDept" parameterType="string" resultType="dept">
      SELECT
         DEPT_CD AS deptCd,
         DEPT_NM AS deptNm
      FROM
         DEPARTMENTS
   </select>
   
   <!-- 부서 변경시 해당 담당자 출력 -->
   <select id="selectFlnmByDeptCd" parameterType="string" resultType="manager">
      SELECT
         FLNM AS flnm,
         MEMBER_ID AS memberId
      FROM
         DEPARTMENTS D, MEMBERS M
      WHERE
         D.MNGR_ID = M.MEMBER_ID
      AND
         D.DEPT_CD = #{deptCd}
   </select>
   
   <!-- 계획정보 -->
   <select id="selectPlanByDmndNo" parameterType="string" resultType="srplanInformation">
      SELECT
         SI.DMND_NO AS dmndNo,
         M.MEMBER_ID AS memberId,
         D.DEPT_NM AS deptNm,
         M.FLNM AS flnm,
         to_char(SI.BGNG_YMD, 'YYYY-MM-DD') AS bgngYmd,
         to_char(SI.END_YMD, 'YYYY-MM-DD') AS endYmd,
         SI.RVW_CN AS rvwCn,
         SI.DEPT_CD AS deptCd
      FROM
         SR_INFORMATION SI, MEMBERS M, DEPARTMENTS D
      WHERE
         SI.DMND_NO = #{dmndNo}
      AND
         SI.DEPT_CD = D.DEPT_CD
      AND
         SI.PIC_ID = M.MEMBER_ID
   </select>
   
   <!-- 계획정보 변경 -->
   <update id="updateSrInfo" parameterType="srplanInformation">
      UPDATE 
         SR_INFORMATION
      SET
         BGNG_YMD = #{srplanInfomation.bgngYmd},
         END_YMD = #{srplanInfomation.endYmd},
         DEPT_CD = #{srplanInfomation.deptCd},
         PIC_ID = #{srplanInfomation.memberId},
         RVW_CN = #{srplanInfomation.rvwCn}
      WHERE
         DMND_NO = #{srplanInfomation.dmndNo}
      
   </update>
   
   <!-- WOR-2023 으로 시작하는 데이터의 수를 가져온다.  -->
   <select id="countBySrNo" parameterType="string" resultType="int">
      SELECT count(SR_NO)
      FROM SR_INFORMATION
      WHERE SR_NO LIKE #{srCode}
   </select>
   
   <!--승인된 요청건을 srInformation 데이터 insert -->
   <insert id="insertSrInformatioin" parameterType="srInformationRequestDto">
      INSERT INTO SR_INFORMATION (
         SR_NO, DMND_NO, DEPT_CD, PIC_ID, RNK, BGNG_YMD, END_YMD)
      VALUES (#{srNo}, #{dmndNo}, #{deptCd}, #{picId}, #{rnk}, #{bgngYmd}, #{endYmd})   
   </insert>
   
   <!-- sr진척목록 전체 행수 조회 -->
   <select id="selectTotalRow" parameterType="map" resultType="int">
      SELECT
         COUNT(SI.SR_NO) as totalRow
      FROM
         SR_INFORMATION SI, SR_DEMAND SD
         <if test="srInfoFilter.taskSeCd != null">
         , TASK T
         </if>
         <if test="srInfoFilter.sysCd != null">
         , SYSTEMS S1
         </if>
         <if test="srInfoFilter.sttsCd != null">
         , STATUS S2 
         </if>
         <if test="srInfoFilter.empId != null">
         , SR_RESOURCES R
         </if>
      WHERE 
          SD.DMND_NO = SI.DMND_NO
      <if test="srInfoFilter.dmndNo != null">
      AND
          SD.DMND_NO LIKE '%'||#{srInfoFilter.dmndNo}||'%'
      </if>
      <if test="srInfoFilter.ttl != null">
      AND
          SD.TTL LIKE '%'||#{srInfoFilter.ttl}||'%'
      </if>
      <if test="srInfoFilter.taskSeCd != null">
      AND
          SD.TASK_SE_CD = T.TASK_SE_CD
      AND 
          SD.TASK_SE_CD = #{srInfoFilter.taskSeCd}
      </if>
      <if test="srInfoFilter.sysCd != null">
      AND
          S1.SYS_CD = SD.SYS_CD
      AND
          SD.SYS_CD = #{srInfoFilter.sysCd}
      </if>
      <if test="srInfoFilter.sttsCd != null">
      AND
          S2.STTS_CD = SD.STTS_CD
      AND
          SD.STTS_CD = #{srInfoFilter.sttsCd}
      </if>
      <if test="srInfoFilter.empId != null">
      AND
          R.SR_NO = SI.SR_NO
      AND
          R.EMP_ID = #{srInfoFilter.empId}
      </if>
   </select>
</mapper>